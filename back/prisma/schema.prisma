// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// Role moved to CommonCode for flexible management
// enum Role {
//   SUPER_ADMIN
//   BUSINESS_ADMIN
//   USER
// }

enum GatheringType {
  FREE
  PAID_CLASS
  DEPOSIT
}

enum GatheringStatus {
  RECRUITING
  FULL
  COMPLETED
  CANCELLED
}

enum ParticipantStatus {
  PENDING
  CONFIRMED
  ATTENDED
  NO_SHOW
  CANCELLED
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  REJECTED
}

enum SettlementStatus {
  PENDING
  COMPLETED
  FAILED
}

enum BadgeCategory {
  BASIC
  HOST
  SPECIAL
  SEASONAL
}

enum PointType {
  EARN
  SPEND
}

enum BannerType {
  MAIN_BANNER
  MAIN_TOP
  MAIN_MIDDLE
  MAIN_BOTTOM
  EVENT
  POPUP
}

enum PopupType {
  MODAL
  BOTTOM_SHEET
  TOAST
}

enum EventStatus {
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
}

enum NoticeType {
  GENERAL
  IMPORTANT
  MAINTENANCE
  EVENT
}

enum FileType {
  PROFILE    // 프로필 이미지
  GATHERING  // 모임 이미지
  POST       // 게시물 이미지
  EVENT      // 이벤트 이미지
  BANNER     // 배너 이미지
  POPUP      // 팝업 이미지
  CATEGORY   // 카테고리 아이콘
  BADGE      // 배지 아이콘
  REVIEW     // 리뷰 이미지
  NOTICE     // 공지사항 첨부파일
  BUSINESS   // 사업자 등록증
  TEMP       // 임시 파일
}

// ============================================
// MODELS
// ============================================

/// 파일 순번 관리 테이블 - 날짜+타입별 순번 관리 (YYMMDD-0000001 형식)
model FileSequence {
  date     String   @map("date")      // YYMMDD 형식
  fileType FileType @map("file_type")
  sequence Int      @default(0)       // 현재 순번
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([date, fileType])
  @@map("file_sequences")
}

/// 파일 마스터 테이블 - 모든 파일 정보 중앙 관리
model File {
  id               String   @id @default(uuid())
  fileType         FileType @map("file_type")
  originalName     String   @map("original_name")              // 원본 파일명
  physicalFileName String?  @map("physical_file_name")         // 물리 파일명 (251117-0000001.jpg)
  savedName        String   @map("saved_name")                 // 저장된 파일명 (파일명+확장자)
  filePath         String   @map("file_path")                  // 파일 경로
  fileExtension    String?  @map("file_extension")             // 파일 확장자 (.jpg, .png 등)
  fileSize         Int      @map("file_size")                  // 파일 크기 (bytes)
  mimeType         String   @map("mime_type")                  // MIME 타입
  url              String                                      // 접근 가능한 URL
  uploadedBy       String?  @map("uploaded_by")
  isDeleted        Boolean  @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt        DateTime? @map("deleted_at")                // 삭제 일시
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  userProfiles     User[]            @relation("ProfileImage")
  gatherings       Gathering[]
  businessProfiles BusinessProfile[]
  banners          Banner[]
  popups           Popup[]
  events           Event[]
  eventThumbnails  Event[]           @relation("EventThumbnails")

  @@index([fileType])
  @@index([uploadedBy])
  @@index([createdAt])
  @@index([physicalFileName])
  @@map("files")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  name              String
  nickname          String?   @unique
  profileImageId    String?   @map("profile_image_id")
  bio               String?
  phone             String?
  location          String?
  gender            String?   // 성별 (CommonCode에서 관리)
  age               Int?      // 나이
  isVerified        Boolean   @default(false) @map("is_verified")
  isPhoneVerified   Boolean   @default(false) @map("is_phone_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  phoneVerifiedAt   DateTime? @map("phone_verified_at")
  isDeleted         Boolean   @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt         DateTime? @map("deleted_at")                 // 삭제 일시
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  profileImage       File?               @relation("ProfileImage", fields: [profileImageId], references: [id], onDelete: SetNull)
  businessProfile    BusinessProfile?
  userLevel          UserLevel?
  userStreak         UserStreak?
  userRoles          UserRole[]              // 다중 역할 지원
  hostedGatherings   Gathering[]             @relation("HostedGatherings")
  participations     GatheringParticipant[]
  interests          UserInterest[]
  bookmarks          Bookmark[]
  sentReviews        Review[]                @relation("SentReviews")
  receivedReviews    Review[]                @relation("ReceivedReviews")
  chatMessages       ChatMessage[]
  sentReports        Report[]                @relation("SentReports")
  receivedReports    Report[]                @relation("ReceivedReports")
  userBadges         UserBadge[]
  pointTransactions  UserPoint[]
  momentCollections  MomentCollection[]
  interestForest     InterestForest[]
  notifications      Notification[]          @relation("UserNotifications")
  notificationReads  NotificationRead[]
  popupViews         PopupView[]
  refreshTokens      RefreshToken[]

  // History Relations
  loginHistory              LoginHistory[]
  roleChanges               RoleChangeHistory[]           @relation("RoleChanges")
  adminRoleChanges          RoleChangeHistory[]           @relation("AdminRoleChanges")
  businessApprovalHistory   BusinessApprovalHistory[]
  reportActions             ReportActionHistory[]         @relation("ReportActions")
  settlementActions         SettlementActionHistory[]     @relation("SettlementActions")
  suspensions               UserSuspensionHistory[]       @relation("UserSuspensions")
  adminSuspensions          UserSuspensionHistory[]       @relation("AdminSuspensions")
  settingChanges            SettingChangeHistory[]        @relation("SettingChanges")

  // Board Relations
  boardPosts                BoardPost[]                   @relation("BoardPosts")
  boardComments             BoardComment[]                @relation("BoardComments")
  boardPostLikes            BoardPostLike[]               @relation("BoardPostLikes")
  boardCommentLikes         BoardCommentLike[]            @relation("BoardCommentLikes")

  @@map("users")
}

/// 사용자 역할 매핑 테이블 - 한 사용자가 여러 역할을 가질 수 있도록 지원
model UserRole {
  /// 역할 매핑 고유 ID
  id        String   @id @default(uuid())
  /// 사용자 ID (users 테이블 참조)
  userId    String   @map("user_id")
  /// 역할 코드 (CommonCode ROLE 그룹의 code 값)
  roleCode  String   @map("role_code")
  /// 주요 역할 여부 (UI에서 대표로 표시할 역할)
  isPrimary Boolean  @default(false) @map("is_primary")
  /// 역할을 부여한 관리자 ID (추적용)
  grantedBy String?  @map("granted_by")
  /// 역할 부여 일시
  grantedAt DateTime @default(now()) @map("granted_at")
  /// 역할 만료일 (임시 역할용, null이면 영구)
  expiresAt DateTime? @map("expires_at")
  /// 생성 일시
  createdAt DateTime @default(now()) @map("created_at")
  /// 수정 일시
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleCode]) // 동일한 사용자에게 같은 역할 중복 방지
  @@index([userId])
  @@index([roleCode])
  @@index([isPrimary])
  @@map("user_roles")
}

model VerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  type      String   // EMAIL or PHONE
  code      String?  // For phone verification (6 digits)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("verification_tokens")
}

model UserLevel {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  level         Int      @default(1)
  growthPoints  Int      @default(0) @map("growth_points")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_levels")
}

model BusinessProfile {
  id                  String    @id @default(uuid())
  userId              String    @unique @map("user_id")
  businessName        String    @map("business_name")
  businessNumber      String    @unique @map("business_number")
  businessAddress     String    @map("business_address")
  businessPhone       String    @map("business_phone")
  businessDescription String?   @map("business_description")
  businessImageId     String?   @map("business_image_id")
  bankName            String?   @map("bank_name")
  bankAccount         String?   @map("bank_account")
  accountHolder       String?   @map("account_holder")
  isApproved          Boolean   @default(false) @map("is_approved")
  approvedBy          String?   @map("approved_by")
  approvedAt          DateTime? @map("approved_at")
  rejectionReason     String?   @map("rejection_reason")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessImage   File?                      @relation(fields: [businessImageId], references: [id], onDelete: SetNull)
  settlements     Settlement[]
  approvalHistory BusinessApprovalHistory[]

  @@map("business_profiles")
}

model Category {
  id          String    @id @default(uuid())
  name        String
  displayName String?   @map("display_name") // 배너에 표시할 짧은 이름
  slug        String
  icon        String?
  color       String?
  description String?
  parentId    String?   @map("parent_id")
  order       Int       @default(0)
  depth       Int       @default(0)  // 0: 최상위, 1: 하위 카테고리
  type        String[]  @default([]) // GATHERING, BOARD, INTEREST 등
  isActive    Boolean   @default(true) @map("is_active")
  isDeleted   Boolean   @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt   DateTime? @map("deleted_at")                 // 삭제 일시
  createdAt   DateTime  @default(now()) @map("created_at")

  // Self-referencing relation for hierarchy
  parent         Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children       Category[]       @relation("CategoryHierarchy")

  gatherings     Gathering[]
  interests      UserInterest[]
  interestForest InterestForest[]
  boardPosts     BoardPost[]      @relation("BoardPostCategory")

  @@unique([name, parentId])
  @@unique([slug, parentId])
  @@map("categories")
}

model UserInterest {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("user_interests")
}

model Gathering {
  id                  String          @id @default(uuid())
  hostId              String          @map("host_id")
  categoryId          String          @map("category_id")
  title               String
  description         String
  gatheringType       GatheringType   @default(FREE) @map("gathering_type")
  imageId             String?         @map("image_id")
  locationAddress     String          @map("location_address")
  locationDetail      String?         @map("location_detail")
  latitude            Decimal?        @db.Decimal(10, 8)
  longitude           Decimal?        @db.Decimal(11, 8)
  scheduledAt         DateTime        @map("scheduled_at")
  durationMinutes     Int             @default(120) @map("duration_minutes")
  maxParticipants     Int             @map("max_participants")
  currentParticipants Int             @default(0) @map("current_participants")
  price               Int             @default(0)
  depositAmount       Int             @default(0) @map("deposit_amount")
  status              GatheringStatus @default(RECRUITING)
  tags                String[]
  isDeleted           Boolean         @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt           DateTime?       @map("deleted_at")                 // 삭제 일시
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  host         User                   @relation("HostedGatherings", fields: [hostId], references: [id], onDelete: Cascade)
  category     Category               @relation(fields: [categoryId], references: [id])
  image        File?                  @relation(fields: [imageId], references: [id], onDelete: SetNull)
  participants GatheringParticipant[]
  bookmarks    Bookmark[]
  reviews      Review[]
  chatRoom     ChatRoom?
  reports      Report[]
  settlements  Settlement[]

  @@map("gatherings")
}

model GatheringParticipant {
  id              String            @id @default(uuid())
  gatheringId     String            @map("gathering_id")
  userId          String            @map("user_id")
  status          ParticipantStatus @default(PENDING)
  depositPaid     Boolean           @default(false) @map("deposit_paid")
  depositRefunded Boolean           @default(false) @map("deposit_refunded")
  paymentId       String?           @map("payment_id")
  joinedAt        DateTime          @default(now()) @map("joined_at")
  attendedAt      DateTime?         @map("attended_at")
  cancelledAt     DateTime?         @map("cancelled_at")

  gathering Gathering @relation(fields: [gatheringId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gatheringId, userId])
  @@map("gathering_participants")
}

model Review {
  id          String    @id @default(uuid())
  gatheringId String    @map("gathering_id")
  reviewerId  String    @map("reviewer_id")
  revieweeId  String    @map("reviewee_id")
  rating      Int
  comment     String?
  reply       String?
  repliedAt   DateTime? @map("replied_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  gathering Gathering @relation(fields: [gatheringId], references: [id], onDelete: Cascade)
  reviewer  User      @relation("SentReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee  User      @relation("ReceivedReviews", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@unique([gatheringId, reviewerId, revieweeId])
  @@map("reviews")
}

model ChatRoom {
  id          String   @id @default(uuid())
  gatheringId String   @unique @map("gathering_id")
  createdAt   DateTime @default(now()) @map("created_at")

  gathering Gathering     @relation(fields: [gatheringId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@map("chat_rooms")
}

model ChatMessage {
  id        String   @id @default(uuid())
  roomId    String   @map("room_id")
  userId    String   @map("user_id")
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model Bookmark {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  gatheringId String   @map("gathering_id")
  createdAt   DateTime @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  gathering Gathering @relation(fields: [gatheringId], references: [id], onDelete: Cascade)

  @@unique([userId, gatheringId])
  @@map("bookmarks")
}

model Report {
  id           String    @id @default(uuid())
  reporterId   String    @map("reporter_id")
  reportedId   String    @map("reported_id")
  gatheringId  String?   @map("gathering_id")
  reasonCode   String    @map("reason_code")
  customReason String?   @map("custom_reason") // "기타" 선택 시 직접 입력
  description  String?
  statusCode   String    @default("PENDING") @map("status_code")
  adminNote    String?   @map("admin_note")
  resolvedBy   String?   @map("resolved_by")
  resolvedAt   DateTime? @map("resolved_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  reporter         User                   @relation("SentReports", fields: [reporterId], references: [id])
  reported         User                   @relation("ReceivedReports", fields: [reportedId], references: [id])
  gathering        Gathering?             @relation(fields: [gatheringId], references: [id])
  reasonCommonCode CommonCode             @relation("ReportReasons", fields: [reasonCode], references: [code])
  statusCommonCode CommonCode             @relation("ReportStatus", fields: [statusCode], references: [code])
  actionHistory    ReportActionHistory[]

  @@map("reports")
}

model Settlement {
  id                String           @id @default(uuid())
  businessProfileId String           @map("business_profile_id")
  gatheringId       String           @map("gathering_id")
  totalAmount       Int              @map("total_amount")
  platformFee       Int              @map("platform_fee")
  settlementAmount  Int              @map("settlement_amount")
  status            SettlementStatus @default(PENDING)
  settledAt         DateTime?        @map("settled_at")
  createdAt         DateTime         @default(now()) @map("created_at")

  businessProfile BusinessProfile            @relation(fields: [businessProfileId], references: [id])
  gathering       Gathering                  @relation(fields: [gatheringId], references: [id])
  actionHistory   SettlementActionHistory[]

  @@map("settlements")
}

// ============================================
// TRUST SYSTEM MODELS
// ============================================

model Badge {
  id             String        @id @default(uuid())
  code           String        @unique
  name           String
  description    String
  icon           String
  category       BadgeCategory
  conditionType  String        @map("condition_type")
  conditionValue Int           @map("condition_value")
  isActive       Boolean       @default(true) @map("is_active")
  isDeleted      Boolean       @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt      DateTime?     @map("deleted_at")                 // 삭제 일시
  createdAt      DateTime      @default(now()) @map("created_at")

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model UserPoint {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  points      Int
  balance     Int
  type        PointType
  source      String
  description String?
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_points")
}

model UserStreak {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  currentStreak    Int      @default(0) @map("current_streak")
  longestStreak    Int      @default(0) @map("longest_streak")
  lastActivityDate DateTime @map("last_activity_date") @db.Date
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

model MomentCollection {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  momentCode String   @map("moment_code")
  momentName String   @map("moment_name")
  momentIcon String   @map("moment_icon")
  isRare     Boolean  @default(false) @map("is_rare")
  earnedAt   DateTime @default(now()) @map("earned_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, momentCode])
  @@map("moment_collections")
}

model InterestForest {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  categoryId         String   @map("category_id")
  participationCount Int      @default(0) @map("participation_count")
  treeLevel          Int      @default(1) @map("tree_level")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("interest_forest")
}

// ============================================
// ADMIN MANAGEMENT MODELS
// ============================================

model CommonCode {
  id          String    @id @default(uuid())
  groupCode   String    @map("group_code")
  code        String    @unique
  name        String
  description String?
  value       String?
  order       Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  isDeleted   Boolean   @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt   DateTime? @map("deleted_at")                 // 삭제 일시
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  reportReasons Report[] @relation("ReportReasons")
  reportStatus  Report[] @relation("ReportStatus")

  @@unique([groupCode, code])
  @@map("common_codes")
}

/// 배너 테이블 - 메인 배너, 상단/중단/하단 배너, 이벤트 배너 등
model Banner {
  /// 배너 고유 ID
  id          String     @id @default(uuid())
  /// 배너 타입 (MAIN_BANNER, MAIN_TOP, MAIN_MIDDLE, MAIN_BOTTOM, EVENT, POPUP)
  type        BannerType
  /// 배너 제목
  title       String
  /// 배너 설명 (선택)
  description String?
  /// 배너 이미지 파일 ID (files 테이블 참조)
  imageId     String?    @map("image_id")
  /// 클릭 시 이동할 링크 URL (선택)
  linkUrl     String?    @map("link_url")
  /// 노출 순서 (낮을수록 먼저 표시)
  order       Int        @default(0)
  /// 노출 시작일
  startDate   DateTime   @map("start_date")
  /// 노출 종료일
  endDate     DateTime   @map("end_date")
  /// 활성화 여부
  isActive    Boolean    @default(true) @map("is_active")
  /// 소프트 삭제 여부
  isDeleted   Boolean    @default(false) @map("is_deleted")
  /// 삭제 일시
  deletedAt   DateTime?  @map("deleted_at")
  /// 총 조회수
  viewCount   Int        @default(0) @map("view_count")
  /// 총 클릭수
  clickCount  Int        @default(0) @map("click_count")
  /// 생성자 ID
  createdBy   String     @map("created_by")
  /// 생성 일시
  createdAt   DateTime   @default(now()) @map("created_at")
  /// 수정 일시
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  image File? @relation(fields: [imageId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("banners")
}

/// 팝업 테이블 - 공지사항 팝업, 이벤트 팝업 등
model Popup {
  /// 팝업 고유 ID
  id          String    @id @default(uuid())
  /// 팝업 타입 (MODAL, BOTTOM_SHEET, TOAST)
  type        PopupType
  /// 팝업 제목
  title       String
  /// 팝업 내용 (HTML 지원)
  content     String    @db.Text
  /// 이미지 파일 ID (files 테이블 참조, 선택)
  imageId     String?   @map("image_id")
  /// 링크 URL (클릭 시 이동)
  linkUrl     String?   @map("link_url")
  /// 버튼 텍스트
  buttonText  String?   @map("button_text")
  /// 노출 시작일
  startDate   DateTime  @map("start_date")
  /// 노출 종료일
  endDate     DateTime  @map("end_date")
  /// 활성화 여부
  isActive    Boolean   @default(true) @map("is_active")
  /// 소프트 삭제 여부
  isDeleted   Boolean   @default(false) @map("is_deleted")
  /// 삭제 일시
  deletedAt   DateTime? @map("deleted_at")
  /// 1회만 표시 여부
  showOnce    Boolean   @default(false) @map("show_once")
  /// 우선순위 (높을수록 먼저 표시)
  priority    Int       @default(0)
  /// 총 조회수
  viewCount   Int       @default(0) @map("view_count")
  /// 생성자 ID
  createdBy   String    @map("created_by")
  /// 생성 일시
  createdAt   DateTime  @default(now()) @map("created_at")
  /// 수정 일시
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  image      File?       @relation(fields: [imageId], references: [id], onDelete: SetNull)
  popupViews PopupView[]

  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("popups")
}

/// 팝업 조회 기록 테이블 - 사용자별 팝업 조회 이력 추적 (1회만 표시 기능 지원)
model PopupView {
  /// 조회 기록 고유 ID
  id        String   @id @default(uuid())
  /// 팝업 ID
  popupId   String   @map("popup_id")
  /// 사용자 ID (비회원은 null)
  userId    String?  @map("user_id")
  /// 조회 일시
  viewedAt  DateTime @default(now()) @map("viewed_at")

  popup     Popup    @relation(fields: [popupId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([popupId, userId])
  @@index([userId])
  @@index([popupId])
  @@map("popup_views")
}

/// Refresh Token 테이블 - 자동 갱신 및 세션 관리
model RefreshToken {
  /// 토큰 고유 ID
  id         String    @id @default(uuid())
  /// 사용자 ID
  userId     String    @map("user_id")
  /// Refresh Token (해시 저장)
  token      String    @unique
  /// 만료 일시
  expiresAt  DateTime  @map("expires_at")
  /// 무효화 여부 (강제 로그아웃 시 사용)
  isRevoked  Boolean   @default(false) @map("is_revoked")
  /// 기기 정보 (User-Agent)
  deviceInfo String?   @map("device_info")
  /// IP 주소
  ipAddress  String?   @map("ip_address")
  /// 마지막 사용 일시
  lastUsedAt DateTime? @map("last_used_at")
  /// 생성 일시
  createdAt  DateTime  @default(now()) @map("created_at")
  /// 수정 일시
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

/// 이벤트 테이블 - 프로모션, 특별 이벤트 등
model Event {
  /// 이벤트 고유 ID
  id               String      @id @default(uuid())
  /// 이벤트 제목
  title            String
  /// 이벤트 설명 (HTML 지원)
  description      String      @db.Text
  /// 메인 이미지 파일 ID (files 테이블 참조)
  imageId          String?     @map("image_id")
  /// 썸네일 이미지 파일 ID (files 테이블 참조, 선택)
  thumbnailImageId String?     @map("thumbnail_image_id")
  /// 이벤트 상태 (SCHEDULED, ACTIVE, ENDED, CANCELLED)
  status           EventStatus @default(SCHEDULED)
  /// 이벤트 시작일
  startDate        DateTime    @map("start_date")
  /// 이벤트 종료일
  endDate          DateTime    @map("end_date")
  /// 최대 참가자 수 (선택)
  maxParticipants  Int?        @map("max_participants")
  /// 현재 참가자 수
  participantCount Int         @default(0) @map("participant_count")
  /// 활성화 여부
  isActive         Boolean     @default(true) @map("is_active")
  /// 소프트 삭제 여부
  isDeleted        Boolean     @default(false) @map("is_deleted")
  /// 삭제 일시
  deletedAt        DateTime?   @map("deleted_at")
  /// 총 조회수
  viewCount        Int         @default(0) @map("view_count")
  /// 총 좋아요 수
  likeCount        Int         @default(0) @map("like_count")
  /// 생성자 ID
  createdBy        String      @map("created_by")
  /// 생성 일시
  createdAt        DateTime    @default(now()) @map("created_at")
  /// 수정 일시
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  image          File? @relation(fields: [imageId], references: [id], onDelete: SetNull)
  thumbnailImage File? @relation("EventThumbnails", fields: [thumbnailImageId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("events")
}

model Notice {
  id          String     @id @default(uuid())
  type        NoticeType @default(GENERAL)
  title       String
  content     String     @db.Text
  isPinned    Boolean    @default(false) @map("is_pinned")
  isActive    Boolean    @default(true) @map("is_active")
  isDeleted   Boolean    @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt   DateTime?  @map("deleted_at")                 // 삭제 일시
  viewCount   Int        @default(0) @map("view_count")
  startDate   DateTime?  @map("start_date")
  endDate     DateTime?  @map("end_date")
  createdBy   String     @map("created_by")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@map("notices")
}

model FAQ {
  id        String   @id @default(uuid())
  category  String
  question  String
  answer    String   @db.Text
  order     Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  viewCount Int      @default(0) @map("view_count")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("faqs")
}

model Terms {
  id        String   @id @default(uuid())
  type      String
  title     String
  content   String   @db.Text
  version   String
  isActive  Boolean  @default(true) @map("is_active")
  isRequired Boolean @default(true) @map("is_required")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("terms")
}

// Admin Menu Management
model MenuCategory {
  id            String     @id @default(uuid())
  name          String
  nameEn        String?    @map("name_en")
  icon          String?
  order         Int        @default(0)
  isActive      Boolean    @default(true) @map("is_active")
  isDeleted     Boolean    @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt     DateTime?  @map("deleted_at")                 // 삭제 일시
  description   String?
  requiredRoles String[]   @default([]) @map("required_roles")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  menuItems     MenuItem[]

  @@map("menu_categories")
}

model MenuItem {
  id             String       @id @default(uuid())
  categoryId     String       @map("category_id")
  category       MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name           String
  nameEn         String?      @map("name_en")
  path           String       @unique
  icon           String?
  order          Int          @default(0)
  isActive       Boolean      @default(true) @map("is_active")
  isDeleted      Boolean      @default(false) @map("is_deleted") // 소프트 삭제 여부
  deletedAt      DateTime?    @map("deleted_at")                 // 삭제 일시
  badge          Int?
  description    String?
  requiredRoles  String[]     @default([]) @map("required_roles")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@map("menu_items")
}

// ============================================
// SETTINGS & FOOTER MODELS
// ============================================

model SiteSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  category  String   @default("general") // general, company, contact, social, etc.
  label     String
  description String?
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

model FooterLink {
  id         String   @id @default(uuid())
  title      String
  url        String
  order      Int      @default(0)
  isExternal Boolean  @default(false) @map("is_external")
  isActive   Boolean  @default(true) @map("is_active")
  category   String   @default("terms") // terms, guide, support, etc.
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("footer_links")
}

// ============================================
// NOTIFICATION SYSTEM MODELS
// ============================================

model Notification {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id") // null이면 전체 알림
  type        String   // SYSTEM, GATHERING, REPORT, etc.
  title       String
  content     String   @db.Text
  link        String?  // 클릭시 이동할 링크
  priority    Int      @default(0) // 0: 일반, 1: 중요, 2: 긴급
  createdAt   DateTime @default(now()) @map("created_at")

  user  User?              @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  reads NotificationRead[]

  @@map("notifications")
}

model NotificationRead {
  id             String       @id @default(uuid())
  notificationId String       @map("notification_id")
  userId         String       @map("user_id")
  readAt         DateTime     @default(now()) @map("read_at")

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@map("notification_reads")
}

// ============================================
// AUDIT & HISTORY MODELS
// ============================================

// 로그인 히스토리
model LoginHistory {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id") // null이면 로그인 실패
  email         String // 로그인 시도한 이메일
  ipAddress     String   @map("ip_address")
  userAgent     String?  @map("user_agent") @db.Text
  device        String? // mobile, desktop, tablet
  browser       String? // Chrome, Safari, Firefox, etc.
  os            String? // Windows, macOS, iOS, Android, etc.
  location      String? // 국가 또는 도시 정보 (선택)
  status        String // SUCCESS, FAILURE
  failureReason String?  @map("failure_reason") // 실패 사유 (잘못된 비밀번호, 계정 없음, 계정 정지 등)
  createdAt     DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_history")
}

// 역할 변경 히스토리
model RoleChangeHistory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id") // 역할이 변경된 사용자
  changedBy   String   @map("changed_by") // 역할을 변경한 관리자
  oldRole     String   @map("old_role")
  newRole     String   @map("new_role")
  reason      String? // 변경 사유
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  user    User @relation("RoleChanges", fields: [userId], references: [id], onDelete: Cascade)
  admin   User @relation("AdminRoleChanges", fields: [changedBy], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([changedBy])
  @@index([createdAt])
  @@map("role_change_history")
}

// 사업자 승인 히스토리
model BusinessApprovalHistory {
  id                String   @id @default(uuid())
  businessProfileId String   @map("business_profile_id")
  approvedBy        String?  @map("approved_by") // 승인/거부한 관리자
  status            String // APPROVED, REJECTED
  reason            String? // 승인/거부 사유
  ipAddress         String?  @map("ip_address")
  createdAt         DateTime @default(now()) @map("created_at")

  businessProfile BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  admin           User?           @relation(fields: [approvedBy], references: [id], onDelete: SetNull)

  @@index([businessProfileId])
  @@index([approvedBy])
  @@index([createdAt])
  @@map("business_approval_history")
}

// 신고 처리 히스토리
model ReportActionHistory {
  id          String   @id @default(uuid())
  reportId    String   @map("report_id")
  actionBy    String   @map("action_by") // 처리한 관리자
  oldStatus   String   @map("old_status")
  newStatus   String   @map("new_status")
  adminNote   String?  @map("admin_note") @db.Text
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  admin  User   @relation("ReportActions", fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([actionBy])
  @@index([createdAt])
  @@map("report_action_history")
}

// 정산 처리 히스토리
model SettlementActionHistory {
  id           String   @id @default(uuid())
  settlementId String   @map("settlement_id")
  actionBy     String   @map("action_by") // 처리한 관리자
  oldStatus    String   @map("old_status")
  newStatus    String   @map("new_status")
  note         String?  @db.Text
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  settlement Settlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  admin      User       @relation("SettlementActions", fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([settlementId])
  @@index([actionBy])
  @@index([createdAt])
  @@map("settlement_action_history")
}

// 사용자 제재 히스토리 (정지/차단)
model UserSuspensionHistory {
  id          String    @id @default(uuid())
  userId      String    @map("user_id") // 제재 대상 사용자
  suspendedBy String    @map("suspended_by") // 제재한 관리자
  type        String // SUSPENSION (정지), BAN (영구 차단), WARNING (경고)
  reason      String    @db.Text
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date") // null이면 영구
  ipAddress   String?   @map("ip_address")
  createdAt   DateTime  @default(now()) @map("created_at")

  user  User @relation("UserSuspensions", fields: [userId], references: [id], onDelete: Cascade)
  admin User @relation("AdminSuspensions", fields: [suspendedBy], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([suspendedBy])
  @@index([createdAt])
  @@map("user_suspension_history")
}

// 중요 설정 변경 히스토리
model SettingChangeHistory {
  id        String   @id @default(uuid())
  changedBy String   @map("changed_by") // 변경한 관리자
  category  String // 설정 카테고리 (COMMON_CODE, SITE_SETTING, MENU, etc.)
  key       String // 변경된 설정 키
  oldValue  String?  @map("old_value") @db.Text
  newValue  String?  @map("new_value") @db.Text
  action    String // CREATE, UPDATE, DELETE
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  admin User @relation("SettingChanges", fields: [changedBy], references: [id], onDelete: Cascade)

  @@index([changedBy])
  @@index([category])
  @@index([createdAt])
  @@map("setting_change_history")
}

// ============================================
// BOARD MODELS
// ============================================

enum BoardPostStatus {
  PUBLISHED
  HIDDEN
  DELETED
}

model BoardPost {
  id          String          @id @default(uuid())
  title       String
  content     String          @db.Text
  authorId    String          @map("author_id")
  categoryId  String?         @map("category_id")
  viewCount   Int             @default(0) @map("view_count")
  likeCount   Int             @default(0) @map("like_count")
  commentCount Int            @default(0) @map("comment_count")
  isPinned    Boolean         @default(false) @map("is_pinned")
  status      BoardPostStatus @default(PUBLISHED)
  images      String[]        @default([])
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  author    User              @relation("BoardPosts", fields: [authorId], references: [id], onDelete: Cascade)
  category  Category?         @relation("BoardPostCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  comments  BoardComment[]
  likes     BoardPostLike[]

  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([isPinned])
  @@map("board_posts")
}

model BoardComment {
  id         String   @id @default(uuid())
  postId     String   @map("post_id")
  authorId   String   @map("author_id")
  content    String   @db.Text
  likeCount  Int      @default(0) @map("like_count")
  parentId   String?  @map("parent_id") // For nested comments
  isDeleted  Boolean  @default(false) @map("is_deleted")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  post    BoardPost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  author  User               @relation("BoardComments", fields: [authorId], references: [id], onDelete: Cascade)
  parent  BoardComment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies BoardComment[]     @relation("CommentReplies")
  likes   BoardCommentLike[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
  @@map("board_comments")
}

model BoardPostLike {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  post BoardPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation("BoardPostLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("board_post_likes")
}

model BoardCommentLike {
  id        String   @id @default(uuid())
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  comment BoardComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User         @relation("BoardCommentLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
  @@map("board_comment_likes")
}
