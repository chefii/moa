# MOA 백엔드 프로젝트 개발 규칙

## 데이터베이스 스키마 작성 규칙

### Prisma Schema 작성 시 필수 사항
1. **모든 모델에 한글 코멘트 추가**
   - 모델 위에 `/// 모델 설명` 형태로 작성
   - 예: `/// 사용자 정보`

2. **모든 필드에 한글 코멘트 추가**
   - 필드 옆에 `// 필드 설명` 형태로 작성
   - 예: `email String @unique // 이메일 (고유)`

3. **관계 필드에도 설명 추가**
   - 관계의 의미를 명확히 설명
   - 예: `user User @relation(fields: [userId], references: [id]) // 작성자`

### 예시
```prisma
/// 사용자 정보
model User {
  id        String   @id @default(cuid()) // 사용자 ID
  email     String   @unique // 이메일 (고유)
  name      String   // 사용자 이름
  createdAt DateTime @default(now()) // 생성일시
  updatedAt DateTime @updatedAt // 수정일시

  posts     Post[] // 작성한 게시물
}

/// 게시물
model Post {
  id        String   @id @default(cuid()) // 게시물 ID
  title     String   // 제목
  content   String   @db.Text // 내용
  userId    String   // 작성자 ID
  createdAt DateTime @default(now()) // 생성일시

  user      User     @relation(fields: [userId], references: [id]) // 작성자
}
```

## API 라우터 작성 규칙

### 모든 라우터 엔드포인트에 Swagger JSDoc 추가

1. **기본 구조**
```typescript
/**
 * @swagger
 * /api/resource:
 *   method:
 *     summary: 한글로 작성된 엔드포인트 설명
 *     tags: [태그명]
 *     security:
 *       - bearerAuth: []  // 인증이 필요한 경우
 *     parameters:
 *       - in: query/path
 *         name: 파라미터명
 *         schema:
 *           type: 타입
 *         description: 설명
 *     requestBody:  // POST/PUT/PATCH인 경우
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - 필수필드
 *             properties:
 *               필드명:
 *                 type: 타입
 *                 example: 예시값
 *                 description: 설명
 *     responses:
 *       200/201:
 *         description: 성공 메시지
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   type: object/array
 *       400:
 *         description: 잘못된 요청
 *       401:
 *         description: 인증 필요
 *       403:
 *         description: 권한 없음
 *       404:
 *         description: 리소스를 찾을 수 없음
 *       500:
 *         description: 서버 오류
 */
router.method('/path', authenticate, async (req: Request, res: Response) => {
  // 구현...
});
```

2. **태그 명명 규칙**
   - Public 엔드포인트: `[리소스명]` (예: `[Users]`, `[Posts]`)
   - Admin 엔드포인트: `[Admin - 리소스명]` (예: `[Admin - Users]`)
   - Auth 엔드포인트: `[Authentication]`

3. **필수 포함 항목**
   - summary: 한글로 명확한 설명
   - tags: 적절한 태그 분류
   - security: 인증이 필요한 경우 bearerAuth 명시
   - parameters: 모든 쿼리/경로 파라미터 문서화
   - requestBody: POST/PUT 요청의 바디 스키마
   - responses: 모든 가능한 HTTP 상태 코드 (200/201, 400, 401, 403, 404, 500)

4. **예시값 포함**
   - 모든 필드에 example 추가
   - 실제 사용 가능한 예시값 사용

### 전체 예시
```typescript
/**
 * @swagger
 * /api/users:
 *   get:
 *     summary: 사용자 목록 조회
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: 페이지 번호
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 20
 *         description: 페이지당 항목 수
 *     responses:
 *       200:
 *         description: 사용자 목록 조회 성공
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   type: array
 *                   items:
 *                     type: object
 *                 pagination:
 *                   type: object
 *                   properties:
 *                     total:
 *                       type: integer
 *                     page:
 *                       type: integer
 *                     limit:
 *                       type: integer
 *                     totalPages:
 *                       type: integer
 *       401:
 *         description: 인증 필요
 *       500:
 *         description: 서버 오류
 */
router.get('/', authenticate, async (req: Request, res: Response) => {
  // 구현...
});

/**
 * @swagger
 * /api/users:
 *   post:
 *     summary: 사용자 생성
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - name
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *                 example: asdf@asdf.com
 *                 description: 이메일
 *               name:
 *                 type: string
 *                 example: 홍길동
 *                 description: 이름
 *     responses:
 *       201:
 *         description: 사용자 생성 성공
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   type: object
 *       400:
 *         description: 필수 필드 누락
 *       401:
 *         description: 인증 필요
 *       500:
 *         description: 서버 오류
 */
router.post('/', authenticate, async (req: Request, res: Response) => {
  // 구현...
});
```

## 코드 작성 일반 규칙

1. **타입 안정성**
   - any 사용 최소화
   - 명확한 타입 정의

2. **에러 처리**
   - 모든 비동기 함수에 try-catch 블록
   - 명확한 에러 메시지 (한글)

3. **응답 형식 통일**
   - success: boolean
   - data: 실제 데이터
   - message: 메시지 (선택적)
   - pagination: 페이징 정보 (목록 조회 시)

4. **인증 및 권한**
   - authenticate 미들웨어로 인증 확인
   - authorize 미들웨어로 권한 확인
   - 관리자 전용 기능은 SUPER_ADMIN 또는 ADMIN 권한 필요

## MOA 프로젝트 공통 패턴

### 1. MOA 브랜딩 및 디자인
- **주요 색상**
  - Primary: `#FF6B6B` (moa-primary)
  - Accent: `#4ECDC4` (moa-accent)
  - Success: `#51CF66`
  - Warning: `#FFD93D`
  - Error: `#FF6B6B`

- **그라디언트**
  - Primary to Accent: `from-moa-primary to-moa-accent`
  - Subtle backgrounds: `from-moa-primary/10 via-white to-moa-accent/10`

- **둥근 모서리**
  - 카드/모달: `rounded-2xl` 또는 `rounded-3xl`
  - 버튼: `rounded-xl`
  - 입력 필드: `rounded-lg`

### 2. 에러 페이지 패턴
```typescript
// 404, 500 등 에러 페이지 작성 시
- MOA 브랜딩 색상 사용
- 그라디언트 배경 (from-moa-primary/10 via-white to-moa-accent/10)
- 명확한 에러 설명 (한글)
- 복구 액션 제공 (홈으로 이동, 이전 페이지로 등)
- 고객센터 링크 제공
- Lucide React 아이콘 사용
```

### 3. 모달/다이얼로그 패턴
```typescript
// 확인 모달, 경고 모달 등
- z-index: 99999 (최상위)
- backdrop: bg-black/50 backdrop-blur-sm
- 둥근 모서리: rounded-3xl
- 헤더에 타입별 색상 (success/warning/danger/info)
- 명확한 액션 버튼 (확인/취소)
```

### 4. API 응답 형식 표준
```typescript
// 성공 응답
{
  success: true,
  data: { ... },
  message?: "성공 메시지" // 선택적
}

// 목록 조회 응답
{
  success: true,
  data: [...],
  pagination: {
    total: number,
    page: number,
    limit: number,
    totalPages: number
  }
}

// 에러 응답
{
  success: false,
  message: "에러 메시지 (한글)",
  error?: "상세 에러 정보" // 개발 환경에만
}
```

### 5. 인증 및 권한 패턴
```typescript
// 인증이 필요한 엔드포인트
router.method('/path', authenticate, async (req, res) => {
  const userId = req.user!.userId;
  // ...
});

// 특정 권한이 필요한 엔드포인트
router.method('/path', authenticate, authorize('SUPER_ADMIN', 'ADMIN'), async (req, res) => {
  // ...
});

// 역할 체크
- SUPER_ADMIN: 모든 권한
- BUSINESS_ADMIN: 사업자 관리 권한
- ADMIN: 일반 관리 권한
- USER: 일반 사용자
```

### 6. 페이징 처리 패턴
```typescript
// 쿼리 파라미터
const { page = 1, limit = 20 } = req.query;
const skip = (Number(page) - 1) * Number(limit);

// Prisma 쿼리
const [items, total] = await Promise.all([
  prisma.model.findMany({
    skip,
    take: Number(limit),
    orderBy: { createdAt: 'desc' },
  }),
  prisma.model.count(),
]);

// 응답
res.json({
  success: true,
  data: items,
  pagination: {
    total,
    page: Number(page),
    limit: Number(limit),
    totalPages: Math.ceil(total / Number(limit)),
  },
});
```

### 7. 파일 업로드 패턴
```typescript
// 파일 타입별 분리
- profile: 프로필 이미지 (최대 5MB)
- post: 게시물 이미지 (최대 10MB, 다중 파일)
- event: 이벤트 이미지 (최대 10MB)
- banner: 배너 이미지 (최대 10MB, 관리자 전용)

// 응답 형식
{
  success: true,
  data: {
    filename: string,
    originalname: string,
    size: number,
    mimetype: string,
    url: string  // 접근 가능한 URL
  }
}
```

### 8. 로깅 패턴
```typescript
// Prisma 쿼리 로그 (개발 환경)
- 쿼리문 출력
- 파라미터 값 표시 (보안에 주의)
- 실행 시간 표시

// 에러 로그
console.error('[기능명] error:', error);
console.error('Stack:', error.stack);
```

### 9. 날짜/시간 처리
```typescript
// 현재 시간
const now = new Date();

// 날짜 비교
startDate: { lte: now }
endDate: { gte: now }

// 날짜 범위 (최근 7일)
createdAt: {
  gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
}
```

### 10. 트랜잭션 패턴
```typescript
// 여러 작업을 원자적으로 처리
const result = await prisma.$transaction(async (tx) => {
  const user = await tx.user.create({ ... });
  await tx.userRole.create({ ... });
  await tx.userLevel.create({ ... });
  return user;
});
```

## 이 규칙의 적용

Claude Code는 다음 작업 시 자동으로 이 규칙을 따릅니다:
- 새로운 Prisma 모델 생성
- 새로운 API 라우터 생성
- 기존 스키마 또는 라우터 수정
- 에러 페이지 작성
- 모달/다이얼로그 작성
- 페이징 처리 구현
- 파일 업로드 기능 구현

모든 코드는 이 규칙을 준수하여 일관성 있고 문서화가 잘 된 상태를 유지해야 합니다.
